<div class="layui-form layui-form-pane" action="">
<div class="layui-form-item">
    <div class="layui-inline">
        <label class="layui-form-label">付款通道</label>
        <div class="layui-input-inline">
            <select id="payChannel" lay-verify="required" lay-filter="payChannel">
                <option value="">不限制</option>
                <option value="vmq">码支付</option>
                <option value="epay">易支付</option>
                <option value="epusdt">USDT</option>
            </select>
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">支付方式</label>
        <div class="layui-input-inline">
            <select id="type" lay-verify="required" lay-filter="type">
                <option value="">不限制</option>
                <option value="1">微信</option>
                <option value="2">支付宝</option>
                <option value="3">赞赏码</option>
                <option value="4">QQ</option>
            </select>
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">订单状态</label>
        <div class="layui-input-inline">
            <select id="state" lay-verify="required" lay-filter="state">
                <option value="">不限制</option>
                <option value="-1">过期</option>
                <option value="0">待支付</option>
                <option value="1">完成</option>
                <option value="2">通知失败</option>
            </select>
        </div>
    </div>
    </div>
</div>

<script type="text/html" id="toolbarDemo">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="add" style="background-color: cornflowerblue;">创建订单</button>
        <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="delGq">删除所有过期订单</button>
        <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="delLast">删除七天前订单</button>

    </div>
</script>
<table id="demo" lay-filter="test"></table>

<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs" lay-event="bd">补单</a>
    <a class="layui-btn layui-btn-xs" lay-event="info">详情</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">删除</a>
</script>

<script>
    var myTable,table,form;
    layui.use(['form','table','laydate'], function(){
        table = layui.table;
        form = layui.form;

        //第一个实例
        myTable = table.render({
            elem: '#demo'
            ,height: 'full-160'
            ,url: 'admin/getOrders'
            ,toolbar: '#toolbarDemo'
            ,where: {
                state:$("#state").val(),
                type:$("#type").val(),
                payChannel:$("#payChannel").val()
            }
            ,cols: [[ //表头
                {field: 'username', title: '商户名称',width:120},
                {field: 'payId', title: '交易号',minWidth:150},
                {field: 'orderId', title: '云端订单编号',minWidth:150},
                {field: 'payChannel', title: '付款通道',width:100,templet: function(d){
                        if (d.payChannel=="vmq"){
                            return '码支付';
                        }if (d.payChannel=="epay"){
                            return '易支付';
                        }else if (d.payChannel=="epusdt"){
                            return 'usdt';
                        }else {
                            return d.payChannel;
                        }
                    }
                },
                {field: 'type', title: '支付方式',width:100,templet: function(d){
                        if (d.type=="0"){
                            return '未扫码';
                        }if (d.type=="1"){
                            return '微信';
                        }else if (d.type=="2"){
                            return '支付宝';
                        }else if (d.type=="3"){
                            return 'QQ';
                        }else if (d.type=="4"){
                            return '微信赞赏码';
                        }else if (d.type=="5"){
                            return '支付宝转账';
                        }else {
                            return d.type;
                        }
                    }
                },
                {field: 'price', title: '订单金额',width:100, align:'center'},
                {field: 'reallyPrice', title: '实际金额',width:100, align:'center'},
                {field: 'state', title: '状态',width:100,align:'center',templet: function(d){
                        if (d.state=="2"){
                            return '<span style="color: orange">通知失败</span>';
                        }else if (d.state=="1"){
                            return '<span style="color: green">完成</span>';
                        }else if (d.state=="0"){
                            return '<span style="color: orange">待支付</span>';
                        }else if (d.state=="-1"){
                            return '<span style="color: red">过期</span>';
                        }
                    }
                },
                {field: 'createDate', title: '创建时间',minWidth:120,templet: function(d){
                        return formatDate(d.createDate);
                    }
                },
                {title: '操作', minWidth: 150, align:'center', toolbar: '#barDemo'}
            ]]
            ,page:true
        });

        function reloadPage(){
            myTable.reload({
                where: {
                    state:$("#state").val(),
                    type:$("#type").val(),
                    payChannel:$("#payChannel").val()
                }
            });
        }

        //监听行工具事件
        table.on('tool(test)', function(obj){ //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
            var data = obj.data //获得当前行数据
                ,layEvent = obj.event; //获得 lay-event 对应的值
            if(layEvent === 'info'){
                var out = "<p>创建时间："+formatDate(data.createDate)+"</p>";
                out += "<p>支付时间："+formatDate(data.payDate)+"</p>";
                out += "<p>关闭时间："+formatDate(data.closeDate)+"</p>";
                layer.alert(out);

            }else if(layEvent === 'bd'){
                layer.confirm('确定要补单吗？该操作将会将该订单标记为已支付，并向您的服务器发送订单完成通知', function(index){
                    layer.msg('操作中', {
                        icon: 16
                        ,shade: 0.01
                    });

                    $.post("admin/setBd","id="+data.id,function (data) {
                        if (data.code==1){
                            layer.msg("操作成功！");
                            reloadPage();
                        }else if(data.code==-2){
                            layer.confirm('补单失败，异步通知返回错误，是否查看通知返回数据？', {
                                btn: ['查看','取消'] //按钮
                            }, function(){
                                alert(data.data);
                            }, function(){
                            });
                        }else{
                            layer.msg(data.msg);
                        }
                    });
                    console.log(data.id);
                });
            }else if(layEvent === 'del'){
                layer.confirm('确定要删除订单吗？', function(index){
                    layer.msg('操作中', {
                        icon: 16
                        ,shade: 0.01
                    });
                    $.post("admin/delOrder","id="+data.id,function (data) {
                        if (data.code==1){
                            layer.msg("操作成功！");
                            reloadPage();
                        }else{
                            layer.msg(data.msg);
                        }
                    });
                    console.log(data.id);
                });
            }
        });
        form.on('select(state)', function(data){
            reloadPage();
        });
        form.on('select(type)', function(data){
            reloadPage();
        });
        form.on('select(payChannel)', function(data){
            reloadPage();
        });

        //头工具栏事件
        table.on('toolbar(test)', function(obj){
            var payId = new Date().getTime();
            var typeHtml = "<select id=\"typeOpt\" lay-verify=\"required\" lay-filter=\"type\">" +
                "               <option value=\"0\" selected>聚合码</option><option value=\"1\">微信</option><option value=\"2\">支付宝</option><option value=\"3\">QQ</option><option value=\"4\">微信赞赏码</option><option value=\"5\">支付宝转账</option>" +
                "           </select>";
            var isHtmlStr = "<select id=\"isHtmlOpt\" lay-verify=\"required\" lay-filter=\"isHtml\">" +
                "               <option value=\"0\">json</option><option value=\"1\" selected>页面</option>" +
                "           </select>";
            switch(obj.event){
                case 'add':
                    layer.confirm("<div style='line-height: 40px;width: 300px'><p>商户编号："+payId+"</p>" +
                        "<p>订单金额：<input id='price' name='price' value='0.1' style='width: 60px' /></p>" +
                        "<p>支付方式："+typeHtml+"</p><p>返回类型："+isHtmlStr+"</p></div>",function () {
                        layer.msg('操作中');
                        var param = $("#token").val();
                        var type = $("#typeOpt").val();
                        var price = $("#price").val();
                        var isHtml = $("#isHtmlOpt").val();
                        var code = creatOrder(payId,param,type,price,isHtml);
                        if (code==1){
                            reloadPage();
                        }
                    });
                    break;
                case 'delGq':
                    layer.confirm('确定要删除所有过期订单吗？', function(index){
                        layer.msg('操作中', {
                            icon: 16
                            ,shade: 0.01
                        });

                        $.post("admin/delGqOrder",function (data) {
                            if (data.code==1){
                                layer.msg("操作成功！");
                                reloadPage();
                            }else{
                                layer.msg(data.msg);
                            }
                        });
                    });

                    break;
                case 'delLast':
                    layer.confirm('确定要删除七天前的所有订单吗？', function(index){
                        layer.msg('操作中', {
                            icon: 16
                            ,shade: 0.01
                        });

                        $.post("admin/delLastOrder",function (data) {
                            if (data.code==1){
                                layer.msg("操作成功！");
                                reloadPage();
                            }else{
                                layer.msg(data.msg);
                            }
                        });
                    });
                    break;
            };
        });
        form.render();
    });
</script>
