<div class="layui-form" action="" id="vmqSetting">

    <div class="layui-form-item" >
        <label class="layui-form-label">后台账号</label>
        <div class="layui-input-block">
            <input type="hidden" id="id" name="id">
            <input type="text" id="username" name="username" lay-verify="required" autocomplete="off" class="layui-input" readonly>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">通讯密钥</label>
        <div class="layui-input-block">
            <input type="text" id="md5key" name="md5key" lay-verify="required" placeholder="请输入通讯密钥" autocomplete="off" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">异步回调</label>
        <div class="layui-input-block">
            <input type="text" id="notifyUrl" name="notifyUrl" lay-verify="required" placeholder="请输入异步回调地址" autocomplete="off" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">同步回调</label>
        <div class="layui-input-block">
            <input type="text" id="returnUrl" name="returnUrl" lay-verify="required" placeholder="请输入支付完成后跳转地址" autocomplete="off" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">订单有效期(分钟)</label>
        <div class="layui-input-block" style="width: 200px">
            <input type="number" id="close" name="close" lay-verify="required" placeholder="请输入创建的订单几分钟后失效" autocomplete="off" class="layui-input">
        </div>
        <label class="layui-form-label">区分方式</label>
        <div class="layui-input-block" style="width: 200px">
            <select id="payQf">
                <option value="1">金额递增</option>
                <option value="2">金额递减</option>
            </select>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">通知邮箱</label>
        <div class="layui-input-block" style="width: 200px">
            <input type="email" id="email" name="email" lay-verify="required" placeholder="请输入通知邮箱" autocomplete="off" class="layui-input">
        </div>

    </div>

    <div class="layui-form-item">
        <label class="layui-form-label"></label>
        <label class="layui-form-label" style="width: fit-content">付款审核通知</label>
        <div class="layui-input-block" style="width: 100px">
            <select id="isApprove">
                <option value="1">是</option><option value="0">否</option>
            </select>
        </div>
        <label class="layui-form-label">付款成功通知</label>
        <div class="layui-input-block" style="width: 100px">
            <select id="isNotice">
                <option value="1">是</option><option value="0">否</option>
            </select>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">支付宝UserId</label>
        <div class="layui-input-block">
            <input type="text" id="aliUserId" name="aliUserId" lay-verify="required" placeholder="请输入支付宝UserId，个人转账使用" autocomplete="off" class="layui-input">
            <button type="button" class="layui-btn" onclick="getAliUserID()">获取UserId</button>
        </div>
    </div>

    <div class="layui-form-item" style="display: flex;">
        <label class="layui-form-label">无金额收款二维码</label>
        <div class="layui-input-block">
            <div class="layui-upload" style="text-align: center;">
                <button type="button" class="layui-btn" id="wxup">上传微信收款码</button><br>
                <div class="layui-upload-list">
                    <img class="layui-upload-img" id="wximg">
                    <p id="wxcs"></p>
                </div>
            </div>
            <div class="layui-upload" style="text-align: center;">
                <button type="button" class="layui-btn" id="zfbup">上传支付宝收款码</button><br>
                <div class="layui-upload-list">
                    <img class="layui-upload-img" id="zfbimg">
                    <p id="zfbcs"></p>
                </div>
            </div>
            <div class="layui-upload" style="text-align: center;">
                <button type="button" class="layui-btn" id="qqup">上传QQ收款码</button><br>
                <div class="layui-upload-list">
                    <img class="layui-upload-img" id="qqimg">
                    <p id="qqcs"></p>
                </div>
            </div>
            <div class="layui-upload" style="text-align: center;">
                <button type="button" class="layui-btn" id="wxzsup">上传微信赞赏码</button><br>
                <div class="layui-upload-list" style="width: 200px;height: 200px;overflow: hidden">
                    <img class="layui-upload-img" id="wxzsimg" style="width: 400px;height: 400px;margin-top: -50px;margin-left: -100px;">
                    <p id="wxzscs"></p>
                </div>
            </div>
        </div>
    </div>


    <div class="layui-form-item" style="text-align: right; display: block">
        <button class="layui-btn" onclick="save()">保存</button>
    </div>

</div>
<style>
    .layui-form-item {
        display: flex;
    }
    .layui-form-label {
        width: 120px;
    }
    .layui-input-block {
        margin-left: 20px;
        width: 500px;
        display: flex;
    }
</style>
<script>

var useLocalUser = false;
    $(".useLocalUser").hide();
    if (useLocalUser) {
        $(".useLocalUser").show();
    }

    layui.use(['form','layer','upload'], function(){
        var table = layui.table,form = layui.form,upload = layui.upload;

        var uploadInst = upload.render({
            elem: '#wxup'
            , url: 'deQrcode2'
            , before: function (obj) {

            }
            , done: function (res) {
                //如果上传失败
                if (res.code == -1) {
                    return layer.msg('上传失败');
                }
                if (res.data==""){
                    return layer.msg('请上传微信无金额收款二维码');
                }
                $('#wximg').attr('src', "enQrcode?url="+res.data);
            }
            , error: function () {
                //演示失败状态，并实现重传
                var demoText = $('#wxcs');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs wxcs">重试</a>');
                demoText.find('.wxcs').on('click', function () {
                    uploadInst.upload();
                });
            }
        });

        var uploadInst2 = upload.render({
            elem: '#zfbup'
            , url: 'deQrcode2'
            , before: function (obj) {

            }
            , done: function (res) {
                //如果上传失败
                if (res.code == -1) {
                    return layer.msg('上传失败');
                }
                if (res.data=="" ){
                    return layer.msg('请上传支付宝无金额收款二维码');
                }
                $('#zfbimg').attr('src', "enQrcode?url="+res.data);
            }
            , error: function () {
                //演示失败状态，并实现重传
                var demoText = $('#zfbcs');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs zfbcs">重试</a>');
                demoText.find('.zfbcs').on('click', function () {
                    uploadInst2.upload();
                });
            }
        });

        var uploadInst3 = upload.render({
            elem: '#qqup'
            , url: 'deQrcode2'
            , before: function (obj) {

            }
            , done: function (res) {
                //如果上传失败
                if (res.code == -1) {
                    return layer.msg('上传失败');
                }
                if (res.data==""){
                    return layer.msg('请上传QQ无金额收款二维码');
                }
                $('#qqimg').attr('src', "enQrcode?url="+res.data);
            }
            , error: function () {
                //演示失败状态，并实现重传
                var demoText = $('#qqcs');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs qqcs">重试</a>');
                demoText.find('.qqcs').on('click', function () {
                    uploadInst3.upload();
                });
            }
        });

        upload.render({
            elem: '#wxzsup'
            ,url: 'upload/'
            ,accept: 'file'
            ,multiple: false
            ,auto: false
            ,bindAction: '#testListAction'
            ,choose: function(obj){
                imgs = [];
                obj.preview(function(index, file, result){
                    $('#wxzsimg').attr('src', result);
                });
            }
        });

    });

    function getAliUserID() {
        layer.confirm("<div style='width: 300px;text-align: center'>请使用支付宝扫一扫<img src='assets/images/aliUserId.jpg' style='width: 200px'></div>"
            ,function (index) {layer.close(index);}
        );
    }

    function save() {
        var wximg = $("#wximg").attr("src");
        var zfbimg = $("#zfbimg").attr("src");
        var qqimg = $("#qqimg").attr("src");
        if (wximg=="" || !wximg){
            layer.msg("请上传微信无金额的收款二维码");
            return;
        }
        if (zfbimg=="" || !zfbimg){
            layer.msg("请上传支付宝无金额的收款二维码");
            return;
        }
        setting.email = $("#email").val();
        setting.notifyUrl = $("#notifyUrl").val();
        setting.returnUrl = $("#returnUrl").val();
        setting.md5key = $("#md5key").val();
        setting.aliUserId = $("#aliUserId").val();
        setting.close = $("#close").val();
        setting.payQf = $("#payQf").val()
        setting.isApprove = $("#isApprove").val();
        setting.isNotice = $("#isNotice").val();
        setting.wxpay = wximg.replace(/enQrcode\?url=/g,"");
        setting.wxzspay = $("#wxzsimg").attr("src");
        setting.zfbpay = zfbimg.replace(/enQrcode\?url=/g,"");
        setting.qqpay = qqimg.replace(/enQrcode\?url=/g,"");
        if (setting.username == ""){
            layer.msg("请输入管理员账号");
            return;
        }
        if (setting.close == ""){
            layer.msg("请输入创建的订单几分钟后失效");
            return;
        }
        if (setting.isApprove == 1 || setting.isNotice == 1) {
            if (setting.email=="" || !email) {
                layer.msg("请输入邮箱地址");
                return;
            }
        }
        if (setting.md5key == ""){
            layer.msg("请输入通讯密钥");
            return;
        }
        $.ajax({
            type: 'POST',
            url: "admin/saveSetting",
            contentType: "application/json",
            async: false,
            data: JSON.stringify(setting),
            datatype: "json",
            success: function (data) {
                if (data.code==1){
                    getSettings();
                }
                layer.msg(data.msg);
            }
        });
    }
    var setting;
    function getSettings() {
        $.post("admin/getSettings",function (data) {
            if (data.code==1){
                setting = data.data;
                $("#id").val(data.data.id);
                $("#username").val(data.data.username);
                $("#email").val(data.data.email);
                $("#notifyUrl").val(data.data.notifyUrl);
                $("#returnUrl").val(data.data.returnUrl);
                $("#md5key").val(data.data.md5key);
                $("#secret").val(data.data.secret);
                $("#aliUserId").val(data.data.aliUserId);
                $("#aliCookie").val(data.data.aliCookie);
                $("#close").val(data.data.close);
                $("#payQf").val(data.data.payQf);
                $("#isApprove").val(data.data.isApprove);
                $("#isNotice").val(data.data.isNotice);

                if (data.data.wxpay!=""){
                    $('#wximg').attr('src', "enQrcode?url="+data.data.wxpay);
                }
                if (data.data.zfbpay!=""){
                    $('#zfbimg').attr('src', "enQrcode?url="+data.data.zfbpay);
                }
                if (data.data.qqpay!=""){
                    $('#qqimg').attr('src', "enQrcode?url="+data.data.qqpay);
                }
                if (data.data.wxzspay!=""){
                    $('#wxzsimg').attr('src', data.data.wxzspay);
                }

                layui.form.render();
            }
        });
    }
    getSettings();
</script>