<div class="layui-form" action="">

    <div class="layui-form-item" >
        <label class="layui-form-label">后台账号</label>
        <div class="layui-input-block">
            <input type="hidden" id="id" name="id">
            <input type="text" id="user" lay-verify="required" autocomplete="off" class="layui-input" readonly>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">订单有效期(分钟)</label>
        <div class="layui-input-block">
            <input type="number" id="close" lay-verify="required" placeholder="请输入创建的订单几分钟后失效" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">通知邮箱</label>
        <div class="layui-input-block">
            <input type="email" id="email" lay-verify="required" placeholder="请输入通知邮箱" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">付款审核通知</label>
        <div class="layui-input-block">
            <select id="isApprove">
                <option value="1">是</option><option value="0">否</option>
            </select>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">付款成功通知</label>
        <div class="layui-input-block">
            <select id="isNotice">
                <option value="1">是</option><option value="0">否</option>
            </select>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">异步回调</label>
        <div class="layui-input-block">
            <input type="text" id="notifyUrl" lay-verify="required" placeholder="请输入异步回调地址" autocomplete="off" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">同步回调</label>
        <div class="layui-input-block">
            <input type="text" id="returnUrl" lay-verify="required" placeholder="请输入支付完成后跳转地址" autocomplete="off" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">通讯密钥</label>
        <div class="layui-input-block">
            <input type="text" id="key" lay-verify="required" placeholder="请输入通讯密钥" autocomplete="off" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">区分方式</label>
        <div class="layui-input-block">
            <div class="layui-upload">
                <select id="payQf">
                    <option value="1">金额递增</option>
                    <option value="2">金额递减</option>
                </select>
            </div>
        </div>
    </div>

    <div class="layui-form-item" style="display: flex;">
        <label class="layui-form-label">无金额收款二维码</label>
        <div class="layui-input-block">
            <div class="layui-upload" style="text-align: center;">
                <button type="button" class="layui-btn" id="wxup">上传微信收款码</button><br>
                <div class="layui-upload-list">
                    <img class="layui-upload-img" id="wximg">
                    <p id="wxcs"></p>
                </div>
            </div>
            <div class="layui-upload" style="text-align: center;">
                <button type="button" class="layui-btn" id="zfbup">上传支付宝收款码</button><br>
                <div class="layui-upload-list">
                    <img class="layui-upload-img" id="zfbimg">
                    <p id="zfbcs"></p>
                </div>
            </div>
        </div>
    </div>

    <div class="layui-form-item" style="text-align: right; display: block">
        <button class="layui-btn" onclick="save()">保存</button>
    </div>

</div>

<style>
    .layui-form-item {
        display: flex;
    }
    .layui-form-label {
        width: 120px;
    }
    .layui-input-block {
        margin-left: 20px;
        width: 500px;
        display: flex;
    }
</style>
<script>
    var useLocalUser = false;
    $(".useLocalUser").hide();
    if (useLocalUser) {
        $(".useLocalUser").show();
    }

    layui.use(['form','layer','upload'], function(){
        var table = layui.table,form = layui.form,upload = layui.upload;

        var uploadInst = upload.render({
            elem: '#wxup'
            , url: 'deQrcode2'
            , before: function (obj) {

            }
            , done: function (res) {
                //如果上传失败
                if (res.code == -1) {
                    return layer.msg('上传失败');
                }
                if (res.data==""){
                    return layer.msg('请上传微信无金额收款二维码');
                }
                $('#wximg').attr('src', "enQrcode?url="+res.data);
            }
            , error: function () {
                //演示失败状态，并实现重传
                var demoText = $('#wxcs');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs wxcs">重试</a>');
                demoText.find('.wxcs').on('click', function () {
                    uploadInst.upload();
                });
            }
        });

        var uploadInst2 = upload.render({
            elem: '#zfbup'
            , url: 'deQrcode2'
            , before: function (obj) {

            }
            , done: function (res) {
                //如果上传失败
                if (res.code == -1) {
                    return layer.msg('上传失败');
                }
                if (res.data=="" ){
                    return layer.msg('请上传支付宝无金额收款二维码');
                }
                $('#zfbimg').attr('src', "enQrcode?url="+res.data);
            }
            , error: function () {
                //演示失败状态，并实现重传
                var demoText = $('#zfbcs');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs zfbcs">重试</a>');
                demoText.find('.zfbcs').on('click', function () {
                    uploadInst2.upload();
                });
            }
        });
        form.render();

    });


    function save() {
        var id = $("#id").val();
        var user = $("#user").val();
        var email = $("#email").val();
        var notifyUrl = $("#notifyUrl").val();
        var returnUrl = $("#returnUrl").val();
        var key = $("#key").val();
        var close = $("#close").val();
        var payQf = $("#payQf").val();
        var isApprove = $("#isApprove").val();
        var isNotice = $("#isNotice").val();
        if (user == ""){
            layer.msg("请输入管理员账号");
            return;
        }

        if (close == ""){
            layer.msg("请输入创建的订单几分钟后失效");
            return;
        }
        if (isApprove == 1 || isNotice == 1) {
            if (email=="" || !email) {
                layer.msg("请输入邮箱地址");
                return;
            }
        }
        var wximg = $("#wximg").attr("src");
        if (wximg=="" || !wximg){
            layer.msg("请上传微信无金额的收款二维码");
            return;
        }
        var zfbimg = $("#zfbimg").attr("src");
        if (zfbimg=="" || !zfbimg){
            layer.msg("请上传支付宝无金额的收款二维码");
            return;
        }
        wximg = wximg.replace(/enQrcode\?url=/g,"");
        zfbimg = zfbimg.replace(/enQrcode\?url=/g,"");
        $.ajax({
            type: 'POST',
            url: "/admin/saveSetting",
            contentType: "application/json",
            async: false,
            data: JSON.stringify( { 'id':id ,'username':user ,'email':email,'isApprove':isApprove,'isNotice':isNotice,
                'notifyUrl':notifyUrl ,'returnUrl':returnUrl ,'md5key':key ,'wxpay':wximg ,'zfbpay':zfbimg ,'close':close,'payQf':payQf} ),
            datatype: "json",
            success: function (data) {
                if (data.code==1){
                    getSettings();
                }
                layer.msg(data.msg);
            }
        });
    }

    function getSettings() {
        $.post("/admin/getSettings",function (data) {
            if (data.code==1){
                $("#id").val(data.data.id);
                $("#user").val(data.data.username);
                $("#email").val(data.data.email);
                $("#notifyUrl").val(data.data.notifyUrl);
                $("#returnUrl").val(data.data.returnUrl);
                $("#key").val(data.data.md5key);
                $("#close").val(data.data.close);
                $("#payQf").val(data.data.payQf);
                $("#isApprove").val(data.data.isApprove);
                $("#isNotice").val(data.data.isNotice);

                if (data.data.wxpay!=""){
                    $('#wximg').attr('src', "enQrcode?url="+data.data.wxpay);
                }
                if (data.data.zfbpay!=""){
                    $('#zfbimg').attr('src', "enQrcode?url="+data.data.zfbpay);
                }
                layui.form.render();
            }
        });
    }
    getSettings();
</script>