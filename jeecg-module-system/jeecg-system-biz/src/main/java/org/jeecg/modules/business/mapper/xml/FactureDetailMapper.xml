<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.business.mapper.FactureDetailMapper">
    <select id="selectByShopsAndPeriod" resultType="org.jeecg.modules.business.vo.FactureDetail">
        WITH LatestPrices AS (
            SELECT sp.sku_id, sp.price, sp.date
            FROM sku_price sp
            JOIN (
                SELECT sku_id, MAX(date) AS max_date
                FROM sku_price
                WHERE date &lt;= #{end} -- Upper limit of date range
                GROUP BY sku_id
            ) latest ON sp.sku_id = latest.sku_id AND sp.date = latest.max_date
        )
        SELECT s.name                               AS 'Boutique',
        po.platform_order_id                        AS 'N° de Mabang',
        po.platform_order_number                    AS 'N° de commande',
        po.tracking_number                          AS 'N° de suivi',
        po.order_time                               AS 'Date de commande',
        po.shipping_time                            AS 'Date d\'expédition',
        po.recipient                                AS 'Nom de client',
        po.country                                  AS 'Pays',
        po.postcode                                 AS 'Code postal',
        JSON_ARRAYAGG(sku.erp_code)                 AS 'SKU',
        JSON_ARRAYAGG(sku.en_name)                  AS 'Nom produits',
        JSON_ARRAYAGG(poc.quantity)                 AS 'Quantité',
        COALESCE(SUM(
            CASE
                WHEN poc.purchase_fee = 0 THEN poc.quantity * lp.price
                ELSE poc.purchase_fee
            END
        ),0)                                        AS 'Frais d\'achat',
        po.fret_fee                                 AS 'Frais de FRET',
        SUM(poc.shipping_fee)                       AS 'Frais de livraison',
        po.order_service_fee + SUM(poc.service_fee) AS 'Frais de service',
        po.picking_fee + SUM(poc.picking_fee)       AS 'Frais de préparation',
        po.packaging_material_fee                   AS 'Frais de matériel d\'emballage',
        SUM(poc.vat)                                AS 'TVA',
        po.shipping_invoice_number                  AS 'N° de facture'
        FROM platform_order po
        JOIN shop s ON po.shop_id = s.id
        RIGHT JOIN platform_order_content poc ON po.id = poc.platform_order_id
        JOIN sku ON poc.sku_id = sku.id
        LEFT JOIN LatestPrices lp ON poc.sku_id = lp.sku_id AND lp.date &lt;= po.order_time
        WHERE shipping_invoice_number IS NOT NULL
        AND poc.erp_status &lt;&gt; 5
        AND po.order_time &gt; #{start}
        AND po.order_time &lt; #{end}
        and po.shop_id IN
        <foreach collection="shopIds" item="shopId" open="(" close=")" separator=",">
            #{shopId}
        </foreach>
        GROUP BY po.id, s.name, po.order_time
        ORDER BY s.name, po.order_time;
    </select>
</mapper>